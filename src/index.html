<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlassView Monitor</title>
    <style>
        :root {
            --glass-bg: rgba(10, 10, 12, 0.95);
            --glass-panel: rgba(30, 30, 35, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --neon-green: #4ade80;
            --neon-red: #f87171;
            --neon-blue: #60a5fa;
            --neon-purple: #c084fc;
            --neon-gold: #fbbf24;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
        }

        body {
            margin: 0; padding: 0;
            background: #050505 url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop') center/cover no-repeat fixed;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            height: 100vh; display: flex; align-items: center; justify-content: center;
            color: var(--text-main); overflow: hidden;
        }

        /* --- Main App Container --- */
        .app-window {
            width: 1100px; height: 800px;
            background: var(--glass-bg);
            backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.9);
            display: flex; overflow: hidden; position: relative;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 80px; background: rgba(0,0,0,0.3);
            border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center; padding-top: 25px;
            flex-shrink: 0;
        }

        .brand-icon {
            width: 40px; height: 40px; background: linear-gradient(135deg, var(--neon-blue), #1e3a8a);
            border-radius: 8px; margin-bottom: 40px; box-shadow: 0 0 15px rgba(96, 165, 250, 0.2);
        }

        .nav-item {
            width: 50px; height: 50px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: var(--text-muted); cursor: pointer;
            margin-bottom: 15px; transition: 0.2s; position: relative;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active { color: var(--neon-blue); background: rgba(96, 165, 250, 0.1); }
        .nav-item.active::before {
            content: ''; position: absolute; left: -15px; width: 4px; height: 20px;
            background: var(--neon-blue); border-radius: 0 4px 4px 0;
        }

        /* --- Main Content --- */
        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; }

        .top-bar {
            height: 60px; border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
        }
        .view-title { font-size: 16px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: #ccc; }
        
        .global-stats { display: flex; gap: 20px; font-size: 11px; font-weight: 600; color: var(--text-muted); font-family: monospace; }
        .stat-item span { color: white; margin-left: 5px; }

        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }
        .content-scroll::-webkit-scrollbar { width: 6px; }
        .content-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        /* --- Views --- */
        .view-section { display: none; height: 100%; animation: fadeIn 0.2s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Cards & Grids --- */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }

        .info-card {
            background: var(--glass-panel); border: 1px solid var(--glass-border);
            border-radius: 8px; padding: 20px; display: flex; flex-direction: column;
        }
        .card-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .card-val { font-size: 24px; font-weight: 300; margin-top: 5px; color: white; }
        .card-sub { font-size: 12px; color: var(--text-muted); margin-top: auto; }

        /* --- Graph --- */
        .graph-area { 
            height: 200px; background: rgba(0,0,0,0.3); border-radius: 8px; 
            margin-bottom: 20px; position: relative; overflow: hidden; border: 1px solid var(--glass-border); 
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* --- Tables --- */
        .table-wrap { background: var(--glass-panel); border: 1px solid var(--glass-border); border-radius: 8px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; text-align: left; font-size: 13px; }
        th { padding: 15px; background: rgba(0,0,0,0.2); font-weight: 600; color: var(--text-muted); font-size: 11px; text-transform: uppercase; }
        td { padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #ccc; }
        tr:hover td { background: rgba(255,255,255,0.03); }
        .pid-cell { font-family: monospace; color: var(--neon-purple); }
        .val-cell { font-family: monospace; color: var(--text-main); }

        /* --- Buttons --- */
        .action-btn { 
            padding: 4px 8px; border: 1px solid var(--glass-border); background: transparent; 
            color: var(--text-muted); border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; transition: 0.2s;
        }
        .action-btn:hover { color: white; border-color: white; }
        .btn-kill { color: var(--neon-red); border-color: rgba(248, 113, 113, 0.3); }
        .btn-kill:hover { background: rgba(248, 113, 113, 0.1); border-color: var(--neon-red); }

        /* --- Badges --- */
        .badge { padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 700; width: fit-content; }
        .badge-safe { background: rgba(74, 222, 128, 0.1); color: var(--neon-green); }
        .badge-warn { background: rgba(251, 191, 36, 0.1); color: var(--neon-gold); }
        .badge-err { background: rgba(248, 113, 113, 0.1); color: var(--neon-red); }

    </style>
</head>
<body>

    <div class="app-window">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="brand-icon"></div>
            <div class="nav-item active" onclick="switchView('dashboard', this)" title="Dashboard">üìä</div>
            <div class="nav-item" onclick="switchView('processes', this)" title="Processes">‚ö°</div>
            <div class="nav-item" onclick="switchView('hardware', this)" title="Hardware">üíª</div>
            <div class="nav-item" onclick="switchView('services', this)" title="Services">‚öôÔ∏è</div>
            <div class="nav-item" onclick="switchView('startup', this)" title="Startup">üöÄ</div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            
            <div class="top-bar">
                <div class="view-title" id="pageTitle">System Overview</div>
                <div class="global-stats">
                    <div class="stat-item">UPTIME: <span id="uptime-val" style="color:var(--neon-blue)">0h 0m</span></div>
                    <div class="stat-item">TASKS: <span id="proc-count" style="color:var(--text-main)">0</span></div>
                    <div class="stat-item">KERNEL: <span id="kernel-val" style="color:var(--text-muted)">...</span></div>
                </div>
            </div>

            <div class="content-scroll">

                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="view-section active">
                    <!-- Quick Stats -->
                    <div class="grid-4">
                        <div class="info-card">
                            <div class="card-label" style="color:var(--neon-blue)">CPU Load</div>
                            <div class="card-val" id="dash-cpu">0%</div>
                            <div class="card-sub" id="dash-temp">0¬∞C</div>
                        </div>
                        <div class="info-card">
                            <div class="card-label" style="color:var(--neon-purple)">Memory</div>
                            <div class="card-val" id="dash-mem">0 GB</div>
                            <div class="card-sub" id="dash-mem-total">of 0 GB</div>
                        </div>
                        <div class="info-card">
                            <div class="card-label" style="color:var(--neon-green)">GPU</div>
                            <div class="card-val" id="dash-gpu">0%</div>
                            <div class="card-sub">Discrete</div>
                        </div>
                        <div class="info-card">
                            <div class="card-label" style="color:var(--neon-gold)">Network</div>
                            <div class="card-val" id="dash-net">0 MB/s</div>
                            <div class="card-sub">Inbound</div>
                        </div>
                    </div>

                    <!-- Graph -->
                    <div class="graph-area">
                        <div style="position:absolute; top:10px; left:15px; font-size:10px; font-weight:700; color:#666; font-family:monospace;">CPU HISTORY</div>
                        <canvas id="cpuCanvas"></canvas>
                    </div>

                    <!-- Security Overview -->
                    <div class="grid-2">
                        <div class="info-card" style="height:auto">
                            <div class="card-label" style="margin-bottom:10px">Security Audit</div>
                            <div id="audit-list" style="display:flex; flex-direction:column; gap:8px;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        <div class="info-card" style="height:auto">
                            <div class="card-label" style="margin-bottom:10px">Recent Logs</div>
                            <div id="log-list" style="font-family:monospace; font-size:11px; color:#888; overflow:hidden;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: PROCESSES -->
                <div id="view-processes" class="view-section">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr><th>PID</th><th>Name</th><th>User</th><th>Status</th><th>CPU%</th><th>Mem</th><th>Action</th></tr>
                            </thead>
                            <tbody id="proc-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: HARDWARE -->
                <div id="view-hardware" class="view-section">
                    <div class="grid-2" id="hw-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- VIEW: SERVICES -->
                <div id="view-services" class="view-section">
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>Service</th><th>Status</th><th>State</th><th>Control</th></tr></thead>
                            <tbody id="service-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW: STARTUP -->
                <div id="view-startup" class="view-section">
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>App Name</th><th>Path</th><th>State</th><th>Action</th></tr></thead>
                            <tbody id="startup-body"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const isTauri = window.__TAURI__ !== undefined;
        const invoke = isTauri ? window.__TAURI__.invoke : null;

        // --- GRAPH STATE ---
        const canvas = document.getElementById('cpuCanvas');
        const ctx = canvas.getContext('2d');
        let cpuHistory = new Array(60).fill(0);

        // --- MAIN LOOP ---
        async function updateData() {
            if (!isTauri) return;

            try {
                // 1. Stats
                const stats = await invoke('get_system_stats');
                updateDashboard(stats);
                updateGraph(stats.cpu_util);

                // 2. Hardware/Audit (Lazy load or every tick? doing every tick for now)
                if (document.getElementById('view-dashboard').classList.contains('active')) {
                    const audit = await invoke('get_security_audit');
                    const logs = await invoke('get_journal_logs');
                    renderAudit(audit, logs);
                }

                // 3. Processes
                if (document.getElementById('view-processes').classList.contains('active')) {
                    const procs = await invoke('get_processes');
                    renderProcs(procs);
                }

                // 4. Services
                if (document.getElementById('view-services').classList.contains('active')) {
                    const svcs = await invoke('get_services');
                    renderServices(svcs);
                }

            } catch(e) { console.error(e); }
        }

        function updateDashboard(stats) {
            document.getElementById('dash-cpu').innerText = stats.cpu_util.toFixed(1) + '%';
            document.getElementById('dash-mem').innerText = (stats.mem_used / 1024 / 1024 / 1024).toFixed(1) + ' GB';
            document.getElementById('dash-mem-total').innerText = 'of ' + (stats.mem_total / 1024 / 1024 / 1024).toFixed(0) + ' GB';
            document.getElementById('dash-net').innerText = (stats.net_in / 1024 / 1024).toFixed(1) + ' MB';
            document.getElementById('dash-temp').innerText = stats.cpu_temp.toFixed(0) + '¬∞C';
            
            // Format Uptime
            const h = Math.floor(stats.uptime / 3600);
            const m = Math.floor((stats.uptime % 3600) / 60);
            document.getElementById('uptime-val').innerText = `${h}h ${m}m`;
            document.getElementById('proc-count').innerText = stats.proc_count || 0; // Requires backend update to pass count if missing
        }

        // --- RENDERERS ---
        function renderProcs(list) {
            const tbody = document.getElementById('proc-body');
            tbody.innerHTML = list.map(p => `
                <tr>
                    <td class="pid-cell">${p.id}</td>
                    <td style="font-weight:600; color:#fff">${p.name}</td>
                    <td style="color:${p.user==='root'?'var(--neon-red)':'#888'}">${p.user}</td>
                    <td>${p.status}</td>
                    <td class="val-cell">${p.cpu.toFixed(1)}%</td>
                    <td class="val-cell">${(p.mem/1024/1024).toFixed(0)} MB</td>
                    <td><button class="action-btn btn-kill" onclick="killProc(${p.id})">KILL</button></td>
                </tr>
            `).join('');
        }

        function renderServices(list) {
            const tbody = document.getElementById('service-body');
            tbody.innerHTML = list.map(s => `
                <tr>
                    <td style="font-weight:600; color:#fff">${s.name}</td>
                    <td><span class="badge ${s.active ? 'badge-safe' : 'badge-err'}">${s.active ? 'ACTIVE' : 'INACTIVE'}</span></td>
                    <td style="font-family:monospace; color:#888">${s.status}</td>
                    <td>
                        <button class="action-btn" onclick="svcCtrl('${s.name}', 'restart')">RESTART</button>
                        <button class="action-btn btn-kill" onclick="svcCtrl('${s.name}', 'stop')">STOP</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderAudit(audit, logs) {
            // Kernel
            document.getElementById('kernel-val').innerText = audit.kernel_version;
            
            // Audit List
            document.getElementById('audit-list').innerHTML = `
                <div style="display:flex; justify-content:space-between; font-size:12px;">
                    <span style="color:#aaa">Secure Boot</span>
                    <span class="badge ${audit.secure_boot ? 'badge-safe' : 'badge-err'}">${audit.secure_boot ? 'ENABLED' : 'DISABLED'}</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:12px;">
                    <span style="color:#aaa">Root Processes</span>
                    <span style="font-family:monospace; color:var(--text-main)">${audit.root_procs}</span>
                </div>
            `;

            // Logs
            document.getElementById('log-list').innerHTML = logs.map(l => 
                `<div style="margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    <span style="color:var(--neon-blue)">${l.time}</span> ${l.msg}
                </div>`
            ).join('');
        }

        async function loadHardware() {
            if(!isTauri) return;
            const hw = await invoke('get_hardware_info');
            document.getElementById('hw-grid').innerHTML = `
                <div class="info-card"><div class="card-label">CPU Model</div><div class="card-val" style="font-size:16px">${hw.cpu_model}</div><div class="card-sub">${hw.cpu_cores} Cores</div></div>
                <div class="info-card"><div class="card-label">Total Memory</div><div class="card-val" style="font-size:16px">${hw.ram_total}</div></div>
                <div class="info-card"><div class="card-label">GPU</div><div class="card-val" style="font-size:16px">${hw.gpu_model}</div></div>
                <div class="info-card"><div class="card-label">OS Distro</div><div class="card-val" style="font-size:16px">${hw.os_distro}</div></div>
            `;
        }

        async function loadStartup() {
            if(!isTauri) return;
            const apps = await invoke('get_startup_apps');
            document.getElementById('startup-body').innerHTML = apps.map(a => `
                <tr>
                    <td style="font-weight:600; color:#fff">${a.name}</td>
                    <td style="color:#666; font-size:11px">${a.path}</td>
                    <td><span class="badge ${a.enabled ? 'badge-safe' : 'badge-warn'}">${a.enabled ? 'ENABLED' : 'DISABLED'}</span></td>
                    <td><button class="action-btn" onclick="toggleStart('${a.path}', ${!a.enabled})">${a.enabled ? 'DISABLE' : 'ENABLE'}</button></td>
                </tr>
            `).join('');
        }

        // --- ACTIONS ---
        async function killProc(pid) {
            if(confirm('Kill process ' + pid + '?') && isTauri) await invoke('kill_process', {pid});
        }
        async function svcCtrl(name, action) {
            if(isTauri) await invoke('control_service', {name, action});
        }
        async function toggleStart(path, enable) {
            if(isTauri) { await invoke('toggle_startup', {path, enable}); loadStartup(); }
        }

        // --- UI UTILS ---
        function switchView(view, el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            const titles = { 'dashboard': 'System Overview', 'processes': 'Active Processes', 'hardware': 'Hardware Specs', 'services': 'System Services', 'startup': 'Startup Applications' };
            document.getElementById('pageTitle').innerText = titles[view];
            
            // Lazy load static data
            if(view === 'hardware') loadHardware();
            if(view === 'startup') loadStartup();
        }

        // --- GRAPH ---
        function updateGraph(val) {
            cpuHistory.push(val);
            cpuHistory.shift();
            drawGraph();
        }

        function drawGraph() {
            if(!canvas.offsetParent) return;
            // Resize if needed
            if(canvas.width !== canvas.parentElement.offsetWidth) {
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
            }
            
            const w = canvas.width; const h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            ctx.beginPath();
            ctx.moveTo(0, h);
            
            const step = w / (cpuHistory.length - 1);
            for(let i=0; i<cpuHistory.length; i++) {
                ctx.lineTo(i*step, h - (cpuHistory[i]/100 * h * 0.9));
            }
            ctx.lineTo(w, h);
            
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, 'rgba(96, 165, 250, 0.2)');
            grad.addColorStop(1, 'rgba(96, 165, 250, 0.0)');
            ctx.fillStyle = grad;
            ctx.fill();
            ctx.strokeStyle = '#60a5fa';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Init
        setInterval(updateData, 1000);
        updateData();
    </script>
</body>
</html>
